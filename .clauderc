package_role: data model for power system simulation and optimization
julia_compat: "^1.10"

design_objectives:
  primary: performance and expressiveness
  description: >
    Comprehensive data model library for power system simulation, optimization, and dynamics analysis.
    Provides the System container and all component types (generators, loads, branches, storage, dynamic models).
    Consumed by PowerSimulations.jl, PowerFlows.jl, PowerNetworkMatrices.jl, and other Sienna packages.
    All code must be written with performance in mind.

  principles:
    - Elegance and concision in both interface and implementation
    - Fail fast with actionable error messages rather than hiding problems
    - Validate invariants explicitly in subtle cases
    - Avoid over-adherence to backwards compatibility for internal helpers

performance_requirements:
  priority: critical
  reference: https://docs.julialang.org/en/v1/manual/performance-tips/

  anti_patterns_to_avoid:
    type_instability:
      description: Functions must return consistent concrete types
      bad: "f(x) = x > 0 ? 1 : 1.0"
      good: "f(x) = x > 0 ? 1.0 : 1.0"
      check: "@code_warntype"

    abstract_field_types:
      description: Struct fields must have concrete types or be parameterized
      bad: "struct Foo; data::AbstractVector; end"
      good: "struct Foo{T<:AbstractVector}; data::T; end"

    untyped_containers:
      bad: "Vector{Any}(), Vector{Real}()"
      good: "Vector{Float64}(), Vector{Int}()"

    non_const_globals:
      bad: "THRESHOLD = 0.5"
      good: "const THRESHOLD = 0.5"

    unnecessary_allocations:
      patterns:
        - use views instead of copies (@view, @views)
        - pre-allocate arrays instead of push! in loops
        - use in-place operations (functions ending with !)

    captured_variables:
      description: Avoid closures that capture variables causing boxing
      solution: pass variables as function arguments instead

    splatting_penalty:
      description: Avoid splatting (...) in performance-critical code

    abstract_return_types:
      description: Avoid returning Union types or abstract types

  best_practices:
    - use @inbounds when bounds are verified
    - use broadcasting (dot syntax) for element-wise operations
    - avoid try-catch in hot paths
    - use function barriers to isolate type instability

  note: >
    Apply these guidelines with judgment. Not every function is performance-critical.
    Focus optimization efforts on hot paths and frequently called code.

file_structure:
  src/:
    key_files:
      - PowerSystems.jl: main module, exports, and includes
      - base.jl: System type definition and core methods
      - definitions.jl: core type definitions and enums
      - deprecated.jl: deprecated function warnings
      - subsystems.jl: subsystem management
      - contingencies.jl: contingency definitions
      - outages.jl: outage modeling
      - component_selector.jl: component selection utilities
      - data_format_conversions.jl: format conversion methods
    subdirectories:
      models/:
        description: core component models and definitions
        key_files:
          - components.jl: base component methods
          - devices.jl: device implementations
          - branches.jl: branch/transmission line definitions
          - topological_elements.jl: buses and topology
          - generation.jl: generation component definitions
          - storage.jl: storage/battery definitions
          - loads.jl: load component definitions
          - reserves.jl: reserve ancillary services
          - services.jl: support all kinds of ancillary services. Super type to reserves
          - static_models.jl: static component definitions
          - dynamic_generator.jl: dynamic generator models
          - dynamic_inverter.jl: dynamic inverter models
          - dynamic_branch.jl: dynamic branch models
          - dynamic_loads.jl: dynamic load models
          - HybridSystem.jl: hybrid renewable + storage systems
          - serialization.jl: component serialization
          - supplemental_constructors.jl: additional constructors
          - supplemental_accessors.jl: getter methods
          - supplemental_setters.jl: setter methods
        subfolders:
          - generated/: auto-generated component type files (DO NOT EDIT directly)
          - cost_functions/: operational cost types (ThermalGenerationCost, StorageCost, etc.)
      parsers/:
        description: data parsing and import functionality
        key_files:
          - common.jl: shared parsing utilities
          - power_system_table_data.jl: CSV/table-based data parsing
          - power_models_data.jl: PowerModels.jl format support
          - psse_dynamic_data.jl: PSS/E dynamic data parsing
        subfolders:
          - pm_io/: PowerModels I/O (matpower.jl, psse.jl, pti.jl)
          - im_io/: InteractiveModels I/O (matlab.jl)
      utils/:
        description: utility functions
        key_files:
          - print.jl: enhanced console display
          - generate_struct_files.jl: generate component definitions
          - logging.jl: logging configuration
          - conversion.jl: unit and format conversions
        subfolders:
          - IO/: data validation (system_checks.jl, branchdata_checks.jl, base_checks.jl)
      descriptors/:
        description: JSON schema and metadata
        files:
          - power_system_structs.json: component structure definitions
          - power_system_inputs.json: input specifications
  test/: test suite
  docs/: documentation source
  scripts/: utility scripts (formatter)

auto_generation:
  description: >
    Component structs are auto-generated from JSON descriptors (src/descriptors/power_system_structs.json).
    Generated files are in src/models/generated/ and should NOT be edited directly.
    Over 140 component types are auto-generated.
  generator: src/utils/generate_struct_files.jl
  workflow:
    - Edit src/descriptors/power_system_structs.json to define/modify struct fields
    - Run the generation script
    - Generated files include docstrings, constructors, and accessors automatically

consumed_by:
  - PowerSimulations.jl: production cost modeling and unit commitment
  - PowerFlows.jl: power flow analysis
  - PowerNetworkMatrices.jl: network matrix calculations
  - PowerSystemsInvestmentsPortfolios.jl: capacity expansion portfolios

dependencies:
  - InfrastructureSystems.jl: base types, system data management, time series
  - PowerFlowData.jl: power flow data handling
  - DataFrames.jl: tabular data processing
  - TimeSeries.jl: time series data management
  - PrettyTables.jl: enhanced console output

core_abstractions:
  System:
    description: Main container for power system data
    file: src/base.jl
    fields:
      - data: IS.SystemData for storing components and time series
      - frequency: system frequency (Hz)
      - bus_numbers: set of bus numbers for validation
      - runchecks: flag for data validation
      - units_settings: unit system settings (SYSTEM_BASE, DEVICE_BASE, NATURAL_UNITS)
    methods: add_component!, remove_component!, get_component, get_components, get_bus, set_units_base_system!

  Component:
    description: Abstract base type for all power system elements
    hierarchy:
      Topology:
        description: network topology elements
        subtypes: Bus (ACBus, DCBus), Arc, Area, LoadZone
      Device:
        description: physical equipment
        subtypes: StaticInjection (generators, loads, storage), Branch (lines, transformers)
      Service:
        description: ancillary services (reserves, AGC)
      DynamicComponent:
        description: dynamic models for stability analysis

  StaticInjection:
    description: Static injection devices (generators, loads, storage)
    subtypes:
      - Generator: ThermalStandard, ThermalMultiStart, HydroDispatch, RenewableDispatch, RenewableNonDispatch
      - Storage: EnergyReservoirStorage, HybridSystem
      - ElectricLoad: PowerLoad, StandardLoad, InterruptiblePowerLoad, ControllableLoad
      - StaticInjectionSubsystem: grouped injection components

  Branch:
    description: Transmission elements connecting buses. Branchs that contain Arcs with ACBuses are AC Branches and branches with DC Buses are DC Branches.
    subtypes:
      - ACBranch: Line, TwoWindingTransformer, PhaseShiftingTransformer, TapTransformer, TwoTerminalHVDCLine, MonitoredLine
      - DCBranch: TModelHVDCLine
      - ControlledBranch: DiscreteControlledACBranch

  DynamicInjection:
    description: Dynamic models for transient stability
    subtypes:
      - DynamicGenerator: synchronous machines with AVR, PSS, TurbineGovernor
      - DynamicInverter: inverter-based resources with converter, filter, controls

  Service:
    description: Ancillary services and system requirements
    subtypes:
      - Reserve: ConstantReserve, VariableReserve, ReserveDemandCurve
      - AGC: automatic generation control
      - TransmissionInterface: interface flow limits

  OperationalCost:
    description: Cost structures for component operations
    subtypes:
      - ThermalGenerationCost: thermal unit costs with fuel, startup, variable O&M
      - HydroGenerationCost: hydro unit costs
      - RenewableGenerationCost: renewable unit costs
      - StorageCost: storage operation costs
      - MarketBidCost: market bid/offer curves

  TimeSeriesData:
    description: Time-varying data attached to components
    types:
      - SingleTimeSeries: single scenario time series
      - Deterministic: deterministic forecast
      - Probabilistic: probabilistic forecast with scenarios

test_patterns:
  location: test/
  runner: julia --project=test test/runtests.jl

code_conventions:
  style_guide_url: https://nrel-sienna.github.io/InfrastructureSystems.jl/stable/style/
  formatter:
    tool: JuliaFormatter
    command: julia -e 'include("scripts/formatter/formatter_code.jl")'
  key_rules:
    constructors: use function Foo() not Foo() = ...
    asserts: prefer InfrastructureSystems.@assert_op over @assert
    globals: UPPER_CASE for constants
    exports: all exports in main module file
    comments: complete sentences, describe why not how

documentation_practices:
  framework: Diataxis (https://diataxis.fr/)
  sienna_guide: https://nrel-sienna.github.io/InfrastructureSystems.jl/stable/docs_best_practices/explanation/

  docstring_requirements:
    scope: all elements of public interface (note IS is selective about exports)
    include: function signatures and arguments list
    automation: DocStringExtensions.TYPEDSIGNATURES (TYPEDFIELDS used sparingly in IS)
    see_also: add links for functions with same name (multiple dispatch)

  api_docs:
    public: docs/src/api/public.md using @autodocs with Public=true, Private=false
    internals: docs/src/api/internals.md

common_tasks:
  dev_local_copy: julia --project=test -e 'using Pkg; Pkg.develop(path = ".")
  run_tests: julia --project=test test/runtests.jl
  run_specific_tests: julia --project=test test/runtests.jl <test_file_name_without_extension>
  run_specific_tests_example: julia --project=test test/runtests.jl test_plant_attributes
  build_docs: julia --project=docs docs/make.jl
  format_code: julia -e 'include("scripts/formatter/formatter_code.jl")'
  check_format: git diff --exit-code
  instantiate_test: julia --project=test -e 'using Pkg; Pkg.instantiate()'
  generate_structs: julia --project=test -e "using InfrastructureSystems; InfrastructureSystems.generate_structs(\"./src/descriptors/power_system_structs.json\", \"./src/models/generated\")"

contribution_workflow:
  branch_naming: feature/description or fix/description (branches in main repo)
  main_branch: main
  pr_process:
    - Create a feature branch in the main repo
    - Make changes following the style guide
    - Run formatter before committing
    - Ensure tests pass
    - Submit pull request

troubleshooting:
  type_instability:
    symptom: Poor performance, many allocations
    diagnosis: "@code_warntype on suspect function"
    solution: See performance_requirements.anti_patterns_to_avoid

  formatter_fails:
    symptom: Formatter command returns error
    solution: julia -e 'include("scripts/formatter/formatter_code.jl")'

  test_failures:
    symptom: Tests fail unexpectedly
    solution: julia --project=test -e 'using Pkg; Pkg.instantiate()'

ai_agent_guidance:
  code_generation_priorities:
    - Performance matters - use concrete types in hot paths
    - Apply anti-patterns list with judgment (not exhaustively everywhere)
    - Run formatter on all changes
    - Add docstrings to public interface elements
    - Consider type stability in performance-critical functions

  when_modifying_code:
    - Read existing code patterns before making changes
    - Maintain consistency with existing style
    - Prefer failing fast with clear errors over silent failures
